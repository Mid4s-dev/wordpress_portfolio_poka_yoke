<?php
/**
 * Core Testimonials Functionality
 * 
 * Handles the registration of testimonials post type and related functionality
 *
 * @package WordPress
 * @subpackage Portfolio
 * @since 1.0
 */

// Exit if accessed directly
if (!defined('ABSPATH')) {
    exit;
}

if (!function_exists('portfolio_testimonials_register_core')) {
    /**
     * Register the testimonials post type
     */
    function portfolio_testimonials_register_core() {
        $labels = array(
            'name'                  => _x('Testimonials', 'Post type general name', 'portfolio'),
            'singular_name'         => _x('Testimonial', 'Post type singular name', 'portfolio'),
            'menu_name'             => _x('Testimonials', 'Admin Menu text', 'portfolio'),
            'name_admin_bar'        => _x('Testimonial', 'Add New on Toolbar', 'portfolio'),
            'add_new'               => __('Add New', 'portfolio'),
            'add_new_item'          => __('Add New Testimonial', 'portfolio'),
            'new_item'              => __('New Testimonial', 'portfolio'),
            'edit_item'             => __('Edit Testimonial', 'portfolio'),
            'view_item'             => __('View Testimonial', 'portfolio'),
            'all_items'             => __('All Testimonials', 'portfolio'),
            'search_items'          => __('Search Testimonials', 'portfolio'),
            'not_found'             => __('No testimonials found.', 'portfolio'),
            'not_found_in_trash'    => __('No testimonials found in Trash.', 'portfolio'),
            'featured_image'        => __('Client Image', 'portfolio'),
            'set_featured_image'    => __('Set client image', 'portfolio'),
            'remove_featured_image' => __('Remove client image', 'portfolio'),
            'use_featured_image'    => __('Use as client image', 'portfolio'),
            'archives'              => __('Testimonial archives', 'portfolio'),
        );
        
        $args = array(
            'labels'             => $labels,
            'public'             => true,
            'publicly_queryable' => true,
            'show_ui'            => true,
            'show_in_menu'       => true,
            'query_var'          => true,
            'rewrite'            => array('slug' => 'testimonials'),
            'capability_type'    => 'post',
            'has_archive'        => true,
            'hierarchical'       => false,
            'menu_position'      => 22,
            'menu_icon'          => 'dashicons-format-quote',
            'supports'           => array('title', 'editor', 'thumbnail'),
            'show_in_rest'       => true,
        );
        
        register_post_type('portfolio_testimonial', $args);
    }
    add_action('init', 'portfolio_testimonials_register_core', 0);
    
    /**
     * Add meta boxes to the testimonial post type
     */
    function portfolio_testimonials_add_meta_boxes() {
        add_meta_box(
            'portfolio_testimonial_details',
            __('Client Details', 'portfolio'),
            'portfolio_testimonials_render_meta_box',
            'portfolio_testimonial',
            'normal',
            'high'
        );
    }
    add_action('add_meta_boxes', 'portfolio_testimonials_add_meta_boxes');
    
    /**
     * Render the meta box
     */
    function portfolio_testimonials_render_meta_box($post) {
        // Add a nonce field
        wp_nonce_field('portfolio_testimonial_meta_box', 'portfolio_testimonial_meta_box_nonce');
        
        // Get existing meta values
        $client_name = get_post_meta($post->ID, '_portfolio_testimonial_client_name', true);
        $client_title = get_post_meta($post->ID, '_portfolio_testimonial_client_title', true);
        $client_company = get_post_meta($post->ID, '_portfolio_testimonial_client_company', true);
        $rating = get_post_meta($post->ID, '_portfolio_testimonial_rating', true);
        
        if (empty($rating)) {
            $rating = 5; // Default to 5 stars
        }
        
        ?>
        <p>
            <label for="portfolio_testimonial_client_name"><?php _e('Client Name:', 'portfolio'); ?></label>
            <input type="text" id="portfolio_testimonial_client_name" name="portfolio_testimonial_client_name" 
                   value="<?php echo esc_attr($client_name); ?>" class="widefat">
        </p>
        
        <p>
            <label for="portfolio_testimonial_client_title"><?php _e('Client Title/Position:', 'portfolio'); ?></label>
            <input type="text" id="portfolio_testimonial_client_title" name="portfolio_testimonial_client_title" 
                   value="<?php echo esc_attr($client_title); ?>" class="widefat">
        </p>
        
        <p>
            <label for="portfolio_testimonial_client_company"><?php _e('Client Company/Organization:', 'portfolio'); ?></label>
            <input type="text" id="portfolio_testimonial_client_company" name="portfolio_testimonial_client_company" 
                   value="<?php echo esc_attr($client_company); ?>" class="widefat">
        </p>
        
        <p>
            <label for="portfolio_testimonial_rating"><?php _e('Rating:', 'portfolio'); ?></label>
            <select id="portfolio_testimonial_rating" name="portfolio_testimonial_rating" class="widefat">
                <option value="5" <?php selected($rating, 5); ?>><?php _e('5 Stars', 'portfolio'); ?></option>
                <option value="4" <?php selected($rating, 4); ?>><?php _e('4 Stars', 'portfolio'); ?></option>
                <option value="3" <?php selected($rating, 3); ?>><?php _e('3 Stars', 'portfolio'); ?></option>
                <option value="2" <?php selected($rating, 2); ?>><?php _e('2 Stars', 'portfolio'); ?></option>
                <option value="1" <?php selected($rating, 1); ?>><?php _e('1 Star', 'portfolio'); ?></option>
            </select>
        </p>
        <?php
    }
    
    /**
     * Save the meta box data
     */
    function portfolio_testimonials_save_meta_box($post_id, $post) {
        // Check if nonce is set
        if (!isset($_POST['portfolio_testimonial_meta_box_nonce'])) {
            return;
        }
        
        // Verify that the nonce is valid
        if (!wp_verify_nonce($_POST['portfolio_testimonial_meta_box_nonce'], 'portfolio_testimonial_meta_box')) {
            return;
        }
        
        // If this is an autosave, don't do anything
        if (defined('DOING_AUTOSAVE') && DOING_AUTOSAVE) {
            return;
        }
        
        // Check the user's permissions
        if ('portfolio_testimonial' === $_POST['post_type']) {
            if (!current_user_can('edit_post', $post_id)) {
                return;
            }
        }
        
        // Save the meta fields
        if (isset($_POST['portfolio_testimonial_client_name'])) {
            update_post_meta($post_id, '_portfolio_testimonial_client_name', 
                sanitize_text_field($_POST['portfolio_testimonial_client_name']));
        }
        
        if (isset($_POST['portfolio_testimonial_client_title'])) {
            update_post_meta($post_id, '_portfolio_testimonial_client_title', 
                sanitize_text_field($_POST['portfolio_testimonial_client_title']));
        }
        
        if (isset($_POST['portfolio_testimonial_client_company'])) {
            update_post_meta($post_id, '_portfolio_testimonial_client_company', 
                sanitize_text_field($_POST['portfolio_testimonial_client_company']));
        }
        
        if (isset($_POST['portfolio_testimonial_rating'])) {
            update_post_meta($post_id, '_portfolio_testimonial_rating', 
                intval($_POST['portfolio_testimonial_rating']));
        }
    }
    add_action('save_post', 'portfolio_testimonials_save_meta_box', 10, 2);
    
    /**
     * Add admin columns for testimonials
     */
    function portfolio_testimonials_set_custom_columns($columns) {
        $new_columns = array(
            'cb' => $columns['cb'],
            'title' => $columns['title'],
            'client_info' => __('Client Info', 'portfolio'),
            'rating' => __('Rating', 'portfolio'),
            'date' => $columns['date']
        );
        return $new_columns;
    }
    add_filter('manage_portfolio_testimonial_posts_columns', 'portfolio_testimonials_set_custom_columns');
    
    /**
     * Add content to custom columns
     */
    function portfolio_testimonials_custom_column_content($column, $post_id) {
        switch ($column) {
            case 'client_info':
                $client_name = get_post_meta($post_id, '_portfolio_testimonial_client_name', true);
                $client_title = get_post_meta($post_id, '_portfolio_testimonial_client_title', true);
                $client_company = get_post_meta($post_id, '_portfolio_testimonial_client_company', true);
                
                if (!empty($client_name)) {
                    echo '<strong>' . esc_html($client_name) . '</strong><br>';
                }
                
                if (!empty($client_title)) {
                    echo esc_html($client_title);
                    if (!empty($client_company)) {
                        echo ', ';
                    }
                }
                
                if (!empty($client_company)) {
                    echo esc_html($client_company);
                }
                break;
                
            case 'rating':
                $rating = get_post_meta($post_id, '_portfolio_testimonial_rating', true);
                if (!empty($rating)) {
                    // Display stars for rating
                    $stars = '';
                    for ($i = 1; $i <= 5; $i++) {
                        if ($i <= $rating) {
                            $stars .= '<span class="dashicons dashicons-star-filled" style="color:#ffb900;"></span>';
                        } else {
                            $stars .= '<span class="dashicons dashicons-star-empty" style="color:#ccc;"></span>';
                        }
                    }
                    echo $stars;
                } else {
                    echo '—';
                }
                break;
        }
    }
    add_action('manage_portfolio_testimonial_posts_custom_column', 'portfolio_testimonials_custom_column_content', 10, 2);
    
    /**
     * Register shortcode for testimonials
     */
    function portfolio_testimonials_shortcode($atts) {
        $atts = shortcode_atts(array(
            'count' => -1,
            'orderby' => 'date',
            'order' => 'DESC',
            'layout' => 'grid',
            'columns' => 3,
            'min_rating' => 0,
        ), $atts);
        
        $args = array(
            'post_type' => 'portfolio_testimonial',
            'posts_per_page' => intval($atts['count']),
            'orderby' => $atts['orderby'],
            'order' => $atts['order'],
            'post_status' => 'publish',
        );
        
        // Filter by minimum rating if specified
        if (intval($atts['min_rating']) > 0) {
            $args['meta_query'] = array(
                array(
                    'key' => '_portfolio_testimonial_rating',
                    'value' => intval($atts['min_rating']),
                    'compare' => '>=',
                    'type' => 'NUMERIC',
                ),
            );
        }
        
        $testimonials = new WP_Query($args);
        
        ob_start();
        
        if ($testimonials->have_posts()) {
            $columns_class = 'portfolio-testimonials-columns-' . intval($atts['columns']);
            echo '<div class="portfolio-testimonials portfolio-testimonials-' . esc_attr($atts['layout']) . ' ' . esc_attr($columns_class) . '">';
            
            while ($testimonials->have_posts()) {
                $testimonials->the_post();
                
                $client_name = get_post_meta(get_the_ID(), '_portfolio_testimonial_client_name', true);
                $client_title = get_post_meta(get_the_ID(), '_portfolio_testimonial_client_title', true);
                $client_company = get_post_meta(get_the_ID(), '_portfolio_testimonial_client_company', true);
                $rating = get_post_meta(get_the_ID(), '_portfolio_testimonial_rating', true);
                
                // Display the testimonial
                ?>
                <div class="portfolio-testimonial">
                    <div class="testimonial-content">
                        <div class="testimonial-quote">
                            <span class="quote-icon dashicons dashicons-format-quote"></span>
                            <?php the_content(); ?>
                        </div>
                        
                        <?php if (!empty($rating)) : ?>
                            <div class="testimonial-rating">
                                <?php 
                                for ($i = 1; $i <= 5; $i++) {
                                    if ($i <= $rating) {
                                        echo '<span class="star star-filled dashicons dashicons-star-filled"></span>';
                                    } else {
                                        echo '<span class="star star-empty dashicons dashicons-star-empty"></span>';
                                    }
                                }
                                ?>
                            </div>
                        <?php endif; ?>
                    </div>
                    
                    <div class="testimonial-author">
                        <?php if (has_post_thumbnail()) : ?>
                            <div class="testimonial-avatar">
                                <?php the_post_thumbnail('thumbnail', array('class' => 'client-image')); ?>
                            </div>
                        <?php endif; ?>
                        
                        <div class="testimonial-author-info">
                            <h4 class="client-name">
                                <?php echo !empty($client_name) ? esc_html($client_name) : get_the_title(); ?>
                            </h4>
                            
                            <?php if (!empty($client_title) || !empty($client_company)) : ?>
                                <p class="client-position">
                                    <?php 
                                    if (!empty($client_title)) {
                                        echo esc_html($client_title);
                                        
                                        if (!empty($client_company)) {
                                            echo ', ';
                                        }
                                    }
                                    
                                    if (!empty($client_company)) {
                                        echo esc_html($client_company);
                                    }
                                    ?>
                                </p>
                            <?php endif; ?>
                        </div>
                    </div>
                </div>
                <?php
            }
            
            echo '</div>';
        } else {
            echo '<p>' . __('No testimonials found.', 'portfolio') . '</p>';
        }
        
        wp_reset_postdata();
        
        return ob_get_clean();
    }
    add_shortcode('portfolio_testimonials', 'portfolio_testimonials_shortcode');
    
    /**
     * Flush rewrite rules after plugin activation
     */
    function portfolio_testimonials_flush_rules() {
        // First, we register the post type
        portfolio_testimonials_register_core();
        
        // Then, we flush the rules
        flush_rewrite_rules();
    }
    add_action('after_switch_theme', 'portfolio_testimonials_flush_rules');
}
