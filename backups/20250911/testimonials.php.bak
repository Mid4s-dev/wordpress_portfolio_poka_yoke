<?php
/**
 * Testimonials Functionality
 * 
 * This file contains all the functionality related to the testimonials feature
 * including post type registration, meta boxes, and display functions.
 *
 * @package WordPress
 * @subpackage Portfolio
 * @since 1.0
 */

// Exit if accessed directly
if (!defined('ABSPATH')) {
    exit;
}

/**
 * Class Portfolio_Testimonials
 * 
 * Handles all testimonial-related functionality
 */
class Portfolio_Testimonials {
    
    /**
     * Constructor
     */
    public function __construct() {
        // Register post type with higher priority to ensure it's registered early
        add_action('init', array($this, 'register_post_type'), 5);
        
        // Add meta boxes
        add_action('add_meta_boxes', array($this, 'add_meta_boxes'));
        
        // Save meta box data
        add_action('save_post', array($this, 'save_meta_box'), 10, 2);
        
        // Add columns to admin list
        add_filter('manage_portfolio_testimonial_posts_columns', array($this, 'set_custom_columns'));
        add_action('manage_portfolio_testimonial_posts_custom_column', array($this, 'custom_column_content'), 10, 2);
        
        // Register shortcode
        add_shortcode('portfolio_testimonials', array($this, 'testimonials_shortcode'));
    }
    
    /**
     * Register the testimonials post type - This is now handled in core-testimonials.php
     * This method remains for backward compatibility but doesn't actually register the post type
     */
    public function register_post_type() {
        // Post type registration is now handled in core-testimonials.php
        // This method remains for backward compatibility
        if (WP_DEBUG) {
            error_log('Portfolio_Testimonials::register_post_type() called but ignored - registration handled in core-testimonials.php');
        }
        
        // Check if the post type is already registered
        $post_types = get_post_types(array(), 'objects');
        if (!isset($post_types['portfolio_testimonial'])) {
            // If not registered yet, call our global function - check core function first then our function
            if (function_exists('portfolio_register_testimonial_post_type')) {
                portfolio_register_testimonial_post_type();
                if (WP_DEBUG) {
                    error_log('Post type portfolio_testimonial was not registered, manually registering from core');
                }
            } else if (function_exists('testimonials_secondary_register_post_type')) {
                testimonials_secondary_register_post_type();
                if (WP_DEBUG) {
                    error_log('Post type portfolio_testimonial was not registered, manually registering now');
                }
            }
        }
    }
    
    /**
     * Add meta boxes to the testimonial post type
     */
    public function add_meta_boxes() {
        add_meta_box(
            'portfolio_testimonial_details',
            __('Client Details', 'portfolio'),
            array($this, 'render_meta_box'),
            'portfolio_testimonial',
            'normal',
            'high'
        );
    }
    
    /**
     * Render the meta box
     */
    public function render_meta_box($post) {
        // Add a nonce field
        wp_nonce_field('portfolio_testimonial_meta_box', 'portfolio_testimonial_meta_box_nonce');
        
        // Get existing meta values
        $client_name = get_post_meta($post->ID, '_portfolio_testimonial_client_name', true);
        $client_title = get_post_meta($post->ID, '_portfolio_testimonial_client_title', true);
        $client_company = get_post_meta($post->ID, '_portfolio_testimonial_client_company', true);
        $rating = get_post_meta($post->ID, '_portfolio_testimonial_rating', true);
        if (empty($rating)) {
            $rating = 5; // Default to 5 stars
        }
        
        ?>
        <p>
            <label for="portfolio_testimonial_client_name"><?php _e('Client Name:', 'portfolio'); ?></label>
            <input type="text" id="portfolio_testimonial_client_name" name="portfolio_testimonial_client_name" 
                   value="<?php echo esc_attr($client_name); ?>" class="widefat">
            <span class="description"><?php _e('Enter the name of the client who provided this testimonial.', 'portfolio'); ?></span>
        </p>
        
        <p>
            <label for="portfolio_testimonial_client_title"><?php _e('Client Title/Position:', 'portfolio'); ?></label>
            <input type="text" id="portfolio_testimonial_client_title" name="portfolio_testimonial_client_title" 
                   value="<?php echo esc_attr($client_title); ?>" class="widefat">
            <span class="description"><?php _e('Enter the job title or position of the client.', 'portfolio'); ?></span>
        </p>
        
        <p>
            <label for="portfolio_testimonial_client_company"><?php _e('Client Company/Organization:', 'portfolio'); ?></label>
            <input type="text" id="portfolio_testimonial_client_company" name="portfolio_testimonial_client_company" 
                   value="<?php echo esc_attr($client_company); ?>" class="widefat">
            <span class="description"><?php _e('Enter the company or organization the client represents.', 'portfolio'); ?></span>
        </p>
        
        <p>
            <label for="portfolio_testimonial_rating"><?php _e('Rating:', 'portfolio'); ?></label>
            <select id="portfolio_testimonial_rating" name="portfolio_testimonial_rating" class="widefat">
                <option value="5" <?php selected($rating, 5); ?>><?php _e('5 Stars', 'portfolio'); ?></option>
                <option value="4" <?php selected($rating, 4); ?>><?php _e('4 Stars', 'portfolio'); ?></option>
                <option value="3" <?php selected($rating, 3); ?>><?php _e('3 Stars', 'portfolio'); ?></option>
                <option value="2" <?php selected($rating, 2); ?>><?php _e('2 Stars', 'portfolio'); ?></option>
                <option value="1" <?php selected($rating, 1); ?>><?php _e('1 Star', 'portfolio'); ?></option>
            </select>
            <span class="description"><?php _e('Select the rating given by the client.', 'portfolio'); ?></span>
        </p>
        <?php
    }
    
    /**
     * Save the meta box data
     */
    public function save_meta_box($post_id, $post) {
        // Check if nonce is set
        if (!isset($_POST['portfolio_testimonial_meta_box_nonce'])) {
            return;
        }
        
        // Verify that the nonce is valid
        if (!wp_verify_nonce($_POST['portfolio_testimonial_meta_box_nonce'], 'portfolio_testimonial_meta_box')) {
            return;
        }
        
        // If this is an autosave, don't do anything
        if (defined('DOING_AUTOSAVE') && DOING_AUTOSAVE) {
            return;
        }
        
        // Check the user's permissions
        if ('portfolio_testimonial' === $_POST['post_type']) {
            if (!current_user_can('edit_post', $post_id)) {
                return;
            }
        }
        
        // Save the meta fields
        if (isset($_POST['portfolio_testimonial_client_name'])) {
            update_post_meta($post_id, '_portfolio_testimonial_client_name', sanitize_text_field($_POST['portfolio_testimonial_client_name']));
        }
        
        if (isset($_POST['portfolio_testimonial_client_title'])) {
            update_post_meta($post_id, '_portfolio_testimonial_client_title', sanitize_text_field($_POST['portfolio_testimonial_client_title']));
        }
        
        if (isset($_POST['portfolio_testimonial_client_company'])) {
            update_post_meta($post_id, '_portfolio_testimonial_client_company', sanitize_text_field($_POST['portfolio_testimonial_client_company']));
        }
        
        if (isset($_POST['portfolio_testimonial_rating'])) {
            update_post_meta($post_id, '_portfolio_testimonial_rating', intval($_POST['portfolio_testimonial_rating']));
        }
    }
    
    /**
     * Set custom columns for the testimonial admin list
     */
    public function set_custom_columns($columns) {
        $new_columns = array(
            'cb' => $columns['cb'],
            'title' => $columns['title'],
            'featured_image' => __('Client Image', 'portfolio'),
            'client_info' => __('Client Information', 'portfolio'),
            'testimonial_excerpt' => __('Testimonial', 'portfolio'),
            'rating' => __('Rating', 'portfolio'),
            'date' => $columns['date']
        );
        return $new_columns;
    }
    
    /**
     * Display custom column content
     */
    public function custom_column_content($column, $post_id) {
        switch ($column) {
            case 'featured_image':
                if (has_post_thumbnail($post_id)) {
                    echo get_the_post_thumbnail($post_id, array(50, 50), array('class' => 'testimonial-client-thumbnail'));
                } else {
                    echo '<div class="testimonial-client-placeholder"><span class="dashicons dashicons-admin-users"></span></div>';
                }
                break;
                
            case 'client_info':
                $client_name = get_post_meta($post_id, '_portfolio_testimonial_client_name', true);
                $client_title = get_post_meta($post_id, '_portfolio_testimonial_client_title', true);
                $client_company = get_post_meta($post_id, '_portfolio_testimonial_client_company', true);
                
                if (!empty($client_name)) {
                    echo '<strong>' . esc_html($client_name) . '</strong><br>';
                }
                
                if (!empty($client_title)) {
                    echo esc_html($client_title);
                }
                
                if (!empty($client_company)) {
                    echo !empty($client_title) ? ', ' : '';
                    echo esc_html($client_company);
                }
                break;
                
            case 'testimonial_excerpt':
                $excerpt = wp_strip_all_tags(get_the_content($post_id));
                echo wp_trim_words($excerpt, 15, '...');
                break;
                
            case 'rating':
                $rating = get_post_meta($post_id, '_portfolio_testimonial_rating', true);
                if (!empty($rating)) {
                    $stars = '';
                    for ($i = 0; $i < 5; $i++) {
                        if ($i < $rating) {
                            $stars .= '<span class="dashicons dashicons-star-filled" style="color:#ffb900;"></span>';
                        } else {
                            $stars .= '<span class="dashicons dashicons-star-empty" style="color:#ccc;"></span>';
                        }
                    }
                    echo $stars;
                } else {
                    echo '—';
                }
                break;
        }
    }
    
    /**
     * Display testimonials using a shortcode
     */
    public function testimonials_shortcode($atts) {
        $atts = shortcode_atts(array(
            'count' => -1,
            'orderby' => 'date',
            'order' => 'DESC',
            'layout' => 'grid', // grid, slider, carousel
            'columns' => 2, // Number of columns for grid layout
        ), $atts);
        
        $args = array(
            'post_type' => 'portfolio_testimonial',
            'posts_per_page' => intval($atts['count']),
            'orderby' => $atts['orderby'],
            'order' => $atts['order'],
            'post_status' => 'publish',
        );
        
        $testimonials = new WP_Query($args);
        
        ob_start();
        
        if ($testimonials->have_posts()) {
            $layout = $atts['layout'];
            $columns_class = 'testimonials-columns-' . intval($atts['columns']);
            
            // Container classes based on layout
            $container_class = 'portfolio-testimonials portfolio-testimonials-' . esc_attr($layout);
            if ($layout === 'grid') {
                $container_class .= ' ' . esc_attr($columns_class);
            }
            
            echo '<div class="' . $container_class . '">';
            
            while ($testimonials->have_posts()) {
                $testimonials->the_post();
                
                // Get testimonial metadata
                $client_name = get_post_meta(get_the_ID(), '_portfolio_testimonial_client_name', true);
                $client_title = get_post_meta(get_the_ID(), '_portfolio_testimonial_client_title', true);
                $client_company = get_post_meta(get_the_ID(), '_portfolio_testimonial_client_company', true);
                $rating = get_post_meta(get_the_ID(), '_portfolio_testimonial_rating', true);
                
                // Default client name if not set
                if (empty($client_name)) {
                    $client_name = get_the_title();
                }
                
                ?>
                <div class="portfolio-testimonial">
                    <div class="testimonial-content">
                        <span class="testimonial-quote-icon">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24">
                                <path d="M11.192 15.757c0-.88-.23-1.618-.69-2.217-.326-.412-.768-.683-1.327-.812-.55-.128-1.07-.137-1.54-.028-.16-.95.077-1.928.65-2.486.566-.553 1.26-.948 2.094-1.194l.793-3.072c-.56.3-1.168.573-1.818.82-.42.202-.8.398-1.15.583-.348.186-.652.34-.91.457l-.308.124c-.6.246-1.082.49-1.444.74-.362.252-.68.564-.958.938-.28.374-.48.787-.625 1.244-.16.485-.25.94-.25 1.368 0 1.37.238 2.514.714 3.432s1.07 1.665 1.78 2.25c.71.583 1.482 1 2.318 1.25.68.21 1.27.315 1.77.315 1.004 0 1.92-.21 2.744-.63.823-.418 1.458-.983 1.905-1.696.448-.714.67-1.49.67-2.33 0-.652-.158-1.234-.476-1.744-.318-.51-.77-.93-1.353-1.262-.583-.333-1.262-.5-2.036-.5h-.047zm10.17 0c0-.88-.23-1.618-.69-2.217-.326-.42-.77-.695-1.327-.813-.55-.117-1.07-.126-1.54-.027-.16-.95.077-1.93.65-2.486.566-.553 1.26-.948 2.094-1.194l.793-3.072c-.56.3-1.168.573-1.818.82-.42.202-.8.398-1.15.583-.348.186-.662.34-.92.457-.42.168-.23.33-.308.125-.6.244-1.08.49-1.444.738-.362.252-.68.564-.958.938-.28.375-.48.788-.625 1.245-.16.485-.25.94-.25 1.368 0 1.37.238 2.514.714 3.432s1.07 1.665 1.78 2.25c.71.583 1.482 1 2.318 1.25.68.21 1.27.315 1.77.315 1.004 0 1.92-.21 2.744-.63.823-.418 1.458-.983 1.905-1.696.448-.714.67-1.49.67-2.33 0-.652-.158-1.234-.476-1.744-.318-.51-.77-.93-1.353-1.262-.583-.333-1.262-.5-2.036-.5h-.047z"/>
                            </svg>
                        </span>
                        <div class="testimonial-text">
                            <?php the_content(); ?>
                        </div>
                        <?php if (!empty($rating)) : ?>
                            <div class="testimonial-rating">
                                <?php
                                for ($i = 1; $i <= 5; $i++) {
                                    if ($i <= $rating) {
                                        echo '<span class="star star-filled">★</span>';
                                    } else {
                                        echo '<span class="star star-empty">☆</span>';
                                    }
                                }
                                ?>
                            </div>
                        <?php endif; ?>
                    </div>
                    <div class="testimonial-meta">
                        <?php if (has_post_thumbnail()) : ?>
                            <div class="testimonial-image">
                                <?php the_post_thumbnail('thumbnail', array('class' => 'client-image')); ?>
                            </div>
                        <?php endif; ?>
                        <div class="testimonial-client-info">
                            <?php if (!empty($client_name)) : ?>
                                <h4 class="client-name"><?php echo esc_html($client_name); ?></h4>
                            <?php endif; ?>
                            
                            <?php if (!empty($client_title) || !empty($client_company)) : ?>
                                <p class="client-position">
                                    <?php
                                    if (!empty($client_title)) {
                                        echo esc_html($client_title);
                                    }
                                    
                                    if (!empty($client_company)) {
                                        echo !empty($client_title) ? ', ' : '';
                                        echo esc_html($client_company);
                                    }
                                    ?>
                                </p>
                            <?php endif; ?>
                        </div>
                    </div>
                </div>
                <?php
            }
            
            echo '</div>';
            
            // Add navigation controls for slider/carousel layouts
            if ($layout === 'slider' || $layout === 'carousel') {
                echo '<div class="testimonial-controls">';
                echo '<button class="testimonial-prev" aria-label="Previous"><span class="dashicons dashicons-arrow-left-alt2"></span></button>';
                echo '<button class="testimonial-next" aria-label="Next"><span class="dashicons dashicons-arrow-right-alt2"></span></button>';
                echo '</div>';
            }
            
        } else {
            echo '<p>' . __('No testimonials found.', 'portfolio') . '</p>';
        }
        
        wp_reset_postdata();
        
        return ob_get_clean();
    }
}

// Initialize the testimonials class
global $portfolio_testimonials;
$portfolio_testimonials = new Portfolio_Testimonials();

// Manual registration of the post type to ensure it's available
// Renamed to avoid conflicts with core-testimonials.php
function testimonials_secondary_register_post_type() {
    $labels = array(
        'name'                  => _x('Testimonials', 'Post type general name', 'portfolio'),
        'singular_name'         => _x('Testimonial', 'Post type singular name', 'portfolio'),
        'menu_name'             => _x('Testimonials', 'Admin Menu text', 'portfolio'),
        'name_admin_bar'        => _x('Testimonial', 'Add New on Toolbar', 'portfolio'),
        'add_new'               => __('Add New', 'portfolio'),
        'add_new_item'          => __('Add New Testimonial', 'portfolio'),
        'new_item'              => __('New Testimonial', 'portfolio'),
        'edit_item'             => __('Edit Testimonial', 'portfolio'),
        'view_item'             => __('View Testimonial', 'portfolio'),
        'all_items'             => __('All Testimonials', 'portfolio'),
        'search_items'          => __('Search Testimonials', 'portfolio'),
        'not_found'             => __('No testimonials found.', 'portfolio'),
        'not_found_in_trash'    => __('No testimonials found in Trash.', 'portfolio'),
        'featured_image'        => __('Client Image', 'portfolio'),
        'set_featured_image'    => __('Set client image', 'portfolio'),
        'remove_featured_image' => __('Remove client image', 'portfolio'),
        'use_featured_image'    => __('Use as client image', 'portfolio'),
        'archives'              => __('Testimonial archives', 'portfolio'),
    );     
    
    $args = array(
        'labels'             => $labels,
        'public'             => true,
        'publicly_queryable' => true,
        'show_ui'            => true,
        'show_in_menu'       => true,
        'query_var'          => true,
        'rewrite'            => array('slug' => 'testimonials'),
        'capability_type'    => 'post',
        'has_archive'        => true,
        'hierarchical'       => false,
        'menu_position'      => 22,
        'menu_icon'          => 'dashicons-format-quote',
        'supports'           => array('title', 'editor', 'thumbnail'),
    );
    
    register_post_type('portfolio_testimonial', $args);
}
add_action('init', 'testimonials_secondary_register_post_type', 0);  // Priority 0 to register early

// Flush rewrite rules on theme activation and plugin activation
function portfolio_testimonials_flush_rules() {
    testimonials_secondary_register_post_type();
    flush_rewrite_rules();
}
add_action('after_switch_theme', 'portfolio_testimonials_flush_rules');

// Register activation hook
if (isset($_GET['activate']) && $_GET['activate'] == 'true') {
    portfolio_testimonials_flush_rules();
}
